// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Settings {
  id                 String  @id @default(uuid())
  tenant_id          String
  electricity_cost_kwh Decimal @db.Decimal(10, 4)
  labor_rate_hourly    Decimal @db.Decimal(10, 2)
  currency_symbol      String  @default("R$")

  @@map("settings")
}

model Printer {
  id                    String   @id @default(uuid())
  tenant_id             String
  name                  String
  purchase_price        Decimal
  shipping_cost         Decimal
  purchase_date         DateTime
  lifespan_hours        Int
  power_consumption_watts Int

  @@map("printers")
}

model Asset {
  id            String   @id @default(uuid())
  tenant_id     String
  name          String
  category      String
  cost          Decimal
  purchase_date DateTime
  @@map("assets")
}

model Filament {
  id             String   @id @default(uuid())
  tenant_id      String
  brand          String
  material_type  String
  color          String
  purchase_price Decimal
  shipping_cost  Decimal
  weight_grams   Int      @default(1000)
  purchase_date  DateTime
  stock_quantity Int
  is_active      Boolean  @default(true)
  @@map("filaments")
}

model Product {
  id                       String            @id @default(uuid())
  tenant_id                String
  name                     String
  category                 String
  base_print_time_minutes  Int
  packaging_cost           Decimal
  preparation_time_minutes Int
  fixed_profit_margin      Decimal
  materials                ProductMaterial[]
  addons                   ProductAddon[]
  orders                   Order[]
  @@map("products")
}

model ProductMaterial {
  id                  String  @id @default(uuid())
  product_id          String
  material_type       String
  required_weight_grams Decimal @db.Decimal(10, 2)
  product             Product @relation(fields: [product_id], references: [id])

  @@map("product_materials")
}

model ProductAddon {
  id         String  @id @default(uuid())
  product_id String
  name       String
  cost_unit  Decimal
  product    Product @relation(fields: [product_id], references: [id])

  @@map("product_addons")
}

model Client {
  id        String  @id @default(uuid())
  tenant_id String
  name      String
  segment   String
  phone     String?
  source    String?
  orders    Order[]
  @@map("clients")
}

model Order {
  id                      String   @id @default(uuid())
  tenant_id               String
  created_at              DateTime @default(now())
  status                  String   @default("PENDING")

  // Relacionamentos Principais
  client_id               String
  product_id              String
  printer_id              String

  // Configuração da Venda
  platform_name           String   // Ex: Shopee, ML
  platform_fee_percent    Decimal  @db.Decimal(10, 2) // Ex: 14.00
  scrap_rate_percent      Decimal  @db.Decimal(10, 2) // Ex: 0.10 (10%)

  // --- DADOS REAIS DE EXECUÇÃO (O que realmente gastou) ---
  print_time_minutes      Int      // Tempo real da impressão

  // Slot 1
  filament_1_id           String?
  filament_1_grams_used   Decimal? @default(0) @db.Decimal(10, 2)

  // Slot 2
  filament_2_id           String?
  filament_2_grams_used   Decimal? @default(0) @db.Decimal(10, 2)

  // Slot 3
  filament_3_id           String?
  filament_3_grams_used   Decimal? @default(0) @db.Decimal(10, 2)

  // Slot 4
  filament_4_id           String?
  filament_4_grams_used   Decimal? @default(0) @db.Decimal(10, 2)

  // --- SNAPSHOT FINANCEIRO (Valores congelados no momento da venda) ---
  final_material_cost     Decimal  @db.Decimal(10, 2)
  final_energy_cost       Decimal  @db.Decimal(10, 2)
  final_depreciation_cost Decimal  @db.Decimal(10, 2)
  final_labor_cost        Decimal  @db.Decimal(10, 2)
  final_platform_fee      Decimal  @db.Decimal(10, 2)

  // Totais
  selling_price           Decimal  @db.Decimal(10, 2)
  net_profit              Decimal  @db.Decimal(10, 2)

  // Foreign Keys
  client                  Client   @relation(fields: [client_id], references: [id])
  product                 Product  @relation(fields: [product_id], references: [id])
  // Opcional: Adicionar relação com Printer se quiser
  // printer              Printer  @relation(fields: [printer_id], references: [id])

  @@map("orders")
}
